name: Deploy Cloudflare Pages

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Cloudflare Pages project name'
        required: true
        type: choice
        options:
          - onlinerecycle
          - ai-solutions-store
          - all

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: List Pages projects
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Listing Cloudflare Pages projects..."
          curl -s "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT/pages/projects" \
            -H "Authorization: Bearer $CF_TOKEN" \
            -H "Content-Type: application/json" | jq '.result[] | {name, subdomain, latest_deployment: .latest_deployment.url}'

      - name: Trigger deployment
        env:
          CF_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CF_ACCOUNT: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          PROJECT: ${{ inputs.project }}
        run: |
          trigger_deploy() {
            local project_name=$1
            echo "Triggering deployment for: $project_name"
            response=$(curl -s -X POST \
              "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT/pages/projects/$project_name/deployments" \
              -H "Authorization: Bearer $CF_TOKEN" \
              -H "Content-Type: application/json")
            echo "$response" | jq '.'
          }

          if [ "$PROJECT" = "all" ]; then
            trigger_deploy "onlinerecycle"
            trigger_deploy "ai-solutions-store"
          else
            trigger_deploy "$PROJECT"
          fi
